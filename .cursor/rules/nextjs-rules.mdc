---
description: ACEDD NGO website & admin panel – Next.js 15 / React 19 / TypeScript 5 / Tailwind / Prisma + MariaDB
alwaysApply: true
globs:
  - "src/**/*.{ts,tsx}"
---

# ACEDD – Project Rules for Cursor

You are working inside the **ACEDD NGO** full-stack Next.js project.

Your goals:

1. **Preserve** the existing architecture, routes, and domain language (Turkish field names, statuses, etc.).
2. **Extend** the admin panel and public site in a consistent, maintainable way.
3. Use **Prisma + MariaDB** as the single source of truth for all persistent data.
4. Keep the project **production-grade**: type-safe, testable, secure, and easy to maintain.

When in doubt, **prefer clarity over cleverness** and **small, focused changes** over large rewrites.

---

## 1. Tech Stack & Global Constraints

- **Framework**: Next.js 15 (App Router)
- **Language**: TypeScript (strict mode)
- **UI**:
  - React 19 function components
  - Tailwind CSS (no ad-hoc inline CSS unless absolutely required)
  - shadcn/ui for base components
- **Backend**:
  - Next.js route handlers (`app/api/**/route.ts`)
  - `src/server` helpers and services
  - Prisma ORM with MariaDB
- **Validation**: Zod schemas as the **single source of truth** for request validation and form types.
- **Testing**:
  - Vitest / Testing Library
  - Target: **≥80% coverage** overall, **≥90%** on critical business logic (`src/server/**`, validation helpers).

General principles:

- All new code must be:
  - **Typed** (no `any` unless well-justified and commented)
  - **Linted & formatted** (ESLint + Prettier)
  - **Covered by tests** where it contains logic.
- Prefer **composition over inheritance**.
- Prefer **pure functions** and deterministic utilities in `src/lib/**`.

---

## 2. High-Level Architecture

### 2.1 App Router Structure

- Public pages live in `src/app/(public)/**`.
- Admin pages live in `src/app/(admin)/admin/**`.
- Shared layouts/components are in `src/components/**` or `src/app/(shared)/**` depending on usage.

Rules:

- **Do not** define business logic in React components.
- **Do** call service / use-case functions from inside components or route handlers:
  - `src/server/services/**`
  - `src/server/useCases/**` (if present)
- For each non-trivial feature:
  - Prefer putting backend logic in `src/server/**` and reusing from API routes.

### 2.2 Domain Modules

Use **domain-oriented structure** where possible:

- `src/modules/membership/**` – Üyelik başvurusu, üyelik yönetimi
- `src/modules/scholarship/**` – Burs başvurusu (burs formu V2, dinamik alanlar)
- `src/modules/board/**` – Yönetim kurulu, CV alanları
- `src/modules/donations/**` – Bağış hesapları, constants
- `src/modules/files/**` – Dosya upload, storage, dataset cleanup

When adding new functionality, ask:

> “Does this belong to an existing module, or do I need a new module under `src/modules`?”

Avoid scattering related code across multiple unrelated folders.

---

## 3. Components & UI Structure

### 3.1 Shared UI Components

Location: `src/components/ui/**`, `src/components/common/**`

- Examples:
  - `Button`, `Input`, `Card`, `Select`, `Textarea`, `Badge`, `FileUpload`, `CollapsibleSection`
- These components must **not** contain domain-specific logic.
- They are reused across public and admin UIs.

### 3.2 Layout Components

Location: `src/components/layout/**`

- Examples:
  - `Header`, `Footer`, `AdminSidebar`, `PublicLayout`
- They define page structure and navigation.
- No business rules; only composition and layout.

### 3.3 Page-Specific Components

Location (examples):

- `src/app/(public)/burs-basvurusu/components/**`
- `src/app/(public)/uyelik-basvurusu/components/**`
- `src/app/(admin)/admin/burs-basvurulari/[id]/components/**`

Rules:

- Page-specific components are **only used in one route tree**.
- If a component is reused in multiple routes, move it into:
  - `src/components/**` or
  - `src/modules/<domain>/components/**` (if domain-specific).

---

## 4. Forms & Validation (Zod + React Hook Form)

Forms are critical in this project (membership application, scholarship application, etc.). You **must** follow these rules:

### 4.1 Single Source of Truth

- Each major form must have a dedicated Zod schema:

  - `src/modules/membership/schemas.ts`
  - `src/modules/scholarship/schemas.ts`

- The schema is used for:
  - Frontend form types (`z.infer<typeof schema>`)
  - Backend request validation in route handlers
  - Optional: Prisma input mapping (DTOs)

**Never** duplicate field definitions manually between frontend and backend; derive types from Zod.

### 4.2 Handling Dates

- Use **normalized date handling**:

  - UI: Date picker gives string or `Date`.
  - Zod: `z.coerce.date()` or `z.string().transform(...)` to `Date`.
  - DB: Prisma `DateTime` in UTC.

- All date fields in forms (e.g. birth dates, education dates) must be normalized through a shared helper:

  - `src/lib/dateHelpers.ts` (e.g. `normalizeDateInput`, `toStartOfDayUTC`)

Avoid ad-hoc parsing inside components.

### 4.3 Numeric Fields

- Numeric form inputs (e.g. income, number of siblings, salary):

  - Use `inputMode="numeric"` and `pattern="[0-9]*"` where relevant.
  - In Zod: use `z.coerce.number()` with min/max constraints where business rules exist.
  - For currency/amounts, keep DB type numeric/decimal, not string.

Validation must fail gracefully and show user-friendly messages in Turkish.

---

## 5. Dynamic Repeatable Fields (Scholarship Form V2)

The scholarship application (burs başvurusu) includes **dynamic lists**:

- Relatives (Akrabalar)
- Schools (Okullar)
- References (Referanslar)

We treat these as **first-class domain entities**.

### 5.1 Prisma Modelling

For each dynamic list, use dedicated Prisma models:

- `Relative` (Akraba)
  - Relation: `ScholarshipApplication` 1 → N `Relative`
  - Fields (example): `degree`, `fullName`, `birthDate`, `education`, `job`, `insuranceStatus`, `healthDisability`, `income`, `phone`, `notes`

- `EducationHistory` (Okul)
  - Relation: `ScholarshipApplication` 1 → N `EducationHistory`
  - Fields (example): `schoolName`, `startDate`, `endDate`, `department`, `ranking`

- `Reference`
  - Relation: `ScholarshipApplication` 1 → N `Reference`
  - Fields (example): `relationship`, `fullName`, `isAceddMember`, `job`, `address`, `phone`

Rules:

- Use `ON DELETE CASCADE`-like semantics via Prisma relations:
  - When a `ScholarshipApplication` is deleted, its relatives/schools/references are also deleted.

### 5.2 Zod Schemas for Dynamic Lists

- Use nested Zod schemas:

  ```ts
  const RelativeSchema = z.object({
    degree: z.string().min(1),
    fullName: z.string().min(1),
    birthDate: z.coerce.date(),
    education: z.string().optional(),
    job: z.string().optional(),
    insuranceStatus: z.string().optional(),
    healthDisability: z.string().optional(),
    income: z.coerce.number().nonnegative(),
    phone: z.string().optional(),
    notes: z.string().optional(),
  });

  const ScholarshipApplicationSchema = z.object({
    // static fields...
    relatives: z.array(RelativeSchema).max(50),
    schools: z.array(SchoolSchema).max(50),
    references: z.array(ReferenceSchema).max(20),
  });
  ```

  These schemas should live in `src/modules/scholarship/schemas.ts`.

### 5.3 Reusable Dynamic Field Array Component

Implement a single reusable component for dynamic lists:

**Location:** `src/components/forms/FieldArray/**`

**Usage:**

Built on top of React Hook Form's `useFieldArray`.

Provides Add, Edit, Delete operations for each item.

Accepts:

- `name` (field path)
- `schema` or field config
- `renderItem` callback
- Button labels / section titles (in Turkish)

Admin and public forms should reuse the same field-array component; only the layout may differ.

---

## 6. Admin Panel Rules

Admin panel is critical for reviewing and managing applications.

### 6.1 Structure

Admin routes live under:
- `src/app/(admin)/admin/**`

Keep each major section in its own directory:

- `admin/burs-basvurulari/**`
- `admin/uyelik-basvurulari/**`
- `admin/yonetim-kurulu/**`
- `admin/ayarlar/**`

### 6.2 Detail Views (V2 Design)

For large entities like scholarship applications:

Use collapsible sections for logical groups:

- Applicant basic info
- Family & relatives
- Education history
- References
- Financial details

Implement a shared `CollapsibleSection` component in `src/components/admin/CollapsibleSection.tsx` and reuse it.

### 6.3 Admin Tables

List pages should:

- Show only key columns for scanning.
- Keep extra data for detail view only.
- Include filters and search where it helps (e.g. status, year).

**Rule of thumb:** if a field does not help with scanning or filtering, show it only in the detail page, not as a table column.

---

## 7. File Uploads & Dataset Cleanup

The project includes uploaded files (images, icons, board member CVs, etc.). We must avoid orphaned files.

### 7.1 File Storage Abstraction

Implement file operations through a small service (e.g. `src/modules/files/fileService.ts`) instead of direct usage in components.

### 7.2 Cleanup Rules

When an event is deleted, its associated images/files must be deleted from storage.

When the favicon/icon is updated, old favicon/icon files must be removed or marked as unused.

For board member CVs:

- Deleting a board member or removing their `cvUrl` should trigger deletion of the old file.

Prefer implementing this via:

- Transactional logic in service functions (e.g. delete DB row + storage file).
- Or background jobs if necessary (but keep the abstraction inside `modules/files`).

---

## 8. Board Members – CV Upload

For Yönetim Kurulu (board members):

Extend the board member model with `cvUrl` (or equivalent).

**Admin panel:**

- On the member edit/create screen, provide a CV upload field using the shared file upload component.

**Public site:**

- In the "Hakkımızda → Yönetim Kurulu" section, render a download link if `cvUrl` is present.

**Rules:**

- Only PDF (or specific whitelisted types) should be accepted.
- Validate file size and type on both frontend and backend.
- `cvUrl` should be a stable reference (e.g. `/uploads/board/cv/<id>.pdf`).

---

## 9. Security, Privacy & Logging

This project handles sensitive personal data (identity, health, income, etc.). Be strict.

### 9.1 Sensitive Fields

Examples (non-exhaustive):

- Identity-related (TC kimlik, full legal name, birthdate)
- Contact info (phone, email, address)
- Health info (disabilities, chronic illness)
- Financial info (income, expenses, assets)

**Rules:**

- Do not log raw sensitive data.
- Use a `secureLogging` helper that:
  - Strips or masks sensitive fields.
  - Logs only high-level metadata (e.g. `applicationId`, `status`, timestamps).

### 9.2 Request Validation & Sanitization

Every API route handling input must:

- Validate with Zod.
- Reject malformed data with a safe error message.
- Never trust client-side data; always re-validate on the server.

### 9.3 reCAPTCHA

Forms exposed to the public (membership, scholarship, contact) must:

- Include a reCAPTCHA token.
- Verify it server-side before processing or persisting the form.
- Handle reCAPTCHA failures gracefully and do not expose internal details.

---

## 10. Testing & QA Expectations

### 10.1 Unit Tests

Focus on:

- `src/lib/**` helpers (e.g. date, validation, secure logging, rate limiting).
- `src/server/**` services/use-cases.

**Aim for:**

- ≥80% project coverage, ≥90% in critical modules (membership, scholarship, file lifecycle, security helpers).

### 10.2 Integration Tests

For key flows:

- Membership application submit
- Scholarship application submit (with dynamic lists)
- Admin review & status change

**Validate:**

- DB state (Prisma)
- File storage behaviour (for uploads)
- Security constraints (no unauthenticated access to admin routes).

---

## 11. Git, Branching & Commits

Use trunk-based development:

- Small, frequent merges into main branch.
- Keep PRs < 300 LOC where possible.

Use Conventional Commits:

- `feat: add scholarship relatives field array`
- `fix: correct date normalization in membership form`
- `chore: update eslint config`
- `test: add coverage for secureLogging`

Each PR must include:

- Passing tests
- Lint/format clean
- Updated types & schemas where needed

---

## 12. Cursor-Specific Rules

These rules are for Cursor AI behaviour.

### 12.1 How to Work with This Project

When the user asks you to:

**Add or change a form:**

- Locate the relevant module's schema (`src/modules/**/schemas.ts`) first.
- Update Zod schema before touching UI.
- Ensure server-side validation and Prisma mapping are aligned.

**Implement dynamic list logic:**

- Reuse the shared dynamic field array component.
- Use nested Zod array schemas.
- Make sure Prisma models exist and relations are consistent.

**Modify admin pages:**

- Use the existing layout and patterns in `src/app/(admin)/admin/**`.
- Use `CollapsibleSection` or similar abstraction instead of custom ad-hoc styling.

**Handle file uploads or cleanup:**

- Go through the file service layer in `src/modules/files/**`.
- Ensure dataset cleanup rules are followed (no orphaned files).

### 12.2 General Cursor Behaviours

When generating or editing code:

**Prefer minimal, focused changes:**

- Keep diffs small and localized.
- Avoid refactoring unrelated files unless explicitly asked.

**Respect existing naming conventions:**

- Turkish field labels and domain terms should remain consistent.

**Preserve types:**

- Do not remove types or weaken them with `any`.

**Update tests and docs whenever you change behaviour:**

- Add/adjust tests in `src/__tests__` or respective module test directory.
- If the behaviour of a public or admin flow changes, update:
  - README sections
  - Runbook / admin usage notes, if present.

---

## 13. Documentation Expectations

Whenever you add a non-trivial feature or change behaviour:

**Update or add:**

- A short note in the main `README.md` or relevant module README.
- If it's an architectural decision, capture it in an ADR-style document (e.g. `docs/adr/xxx-burs-form-v2.md`).

**Ensure that:**

- Onboarding a new developer into the project is possible using:
  - README
  - This `nextjs-rules.mdc`
  - Module-level documentation.
